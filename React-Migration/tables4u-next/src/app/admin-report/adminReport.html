<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Reservations</title>

</head>
<body>
    <div> </div>
    <div class="header-title">
        <h1 id="restaurant_name_display">(Restaurant Name)</h1>
    </div>
    <div class="container" id="accordion-container">
        <!-- Accordion for each hour -->
    </div>

    <script>
        const restaurantAddress = sessionStorage.getItem('restaurantAddress'); // Get the restaurant address
        const restaurantName = sessionStorage.getItem('restaurantUsername');
        document.getElementById('restaurant_name_display').textContent = `${restaurantName}`;


        async function fetchReservations() {
            try {
                const response = await fetch('https://x51lo0cnd3.execute-api.us-east-2.amazonaws.com/Stage1/getReservations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ restaurantAddress }),
                });

                if (!response.ok) throw new Error('Failed to fetch reservations');

                const data = await response.json();
                const responseBody = JSON.parse(data.body);

                const reservations = responseBody.reservations;
                const tables = responseBody.tables; // Assume API also returns a list of all tables
                const openTime = responseBody.openTime; // Open time from API
                const closeTime = responseBody.closeTime; // Close time from API
                const tableNum = responseBody.tableNum;

                const hours = calculateHours(openTime, closeTime);
                renderAccordion(reservations, tables, hours);
            } catch (error) {
                console.error('Error fetching reservations:', error.message);
                document.getElementById('accordion-container').innerHTML = '<p>Failed to load reservations.</p>';
            }
        }

        function calculateHours(openTime, closeTime) {
            const hours = [];
            let current = new Date(`1970-01-01T${openTime}`);
            const end = new Date(`1970-01-01T${closeTime}`);

            while (current <= end) {
                hours.push(current.toTimeString().slice(0, 5)); // Add HH:MM format
                current.setHours(current.getHours() + 1);
            }
            return hours;
        }

        function renderAccordion(reservations, tables, hours) {
            const container = document.getElementById('accordion-container');
            container.innerHTML = ''; // Clear existing content

            hours.forEach(hour => {
                // Filter out reserved tables for the current hour
                const reservedTableIDs = reservations
                    .filter(res => res.reserveTime.startsWith(hour))
                    .map(res => res.tableID);

                const availableTables = tables.filter(table => !reservedTableIDs.includes(table.tableID));

                const accordionItem = `
                    <div class="accordion">
                        <button class="accordion-header" onclick="toggleAccordion(this)">${hour}</button>
                        <div class="accordion-content">
                            ${
                                availableTables.length
                                    ? availableTables.map(table => `
                                        <div class="table-item">
                                            <span>Table ${table.tableNum} - Seats: ${table.numSeats}</span>
                                            <input type="email" placeholder="Enter email" id="email_${table.tableID}_${hour}">
                                            <button onclick="makeReservation('${table.tableNum}','${table.tableID}', '${hour}')">Reserve</button>
                                        </div>
                                    `).join('')
                                    : '<p>No tables available at this time.</p>'
                            }
                        </div>
                    </div>
                `;
                container.innerHTML += accordionItem;
            });
        }

        function toggleAccordion(button) {
            const content = button.nextElementSibling;
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        }

        async function makeReservation(tableNum, tableID, reserveTime) {
            const emailInput = document.getElementById(`email_${tableID}_${reserveTime}`);
            const email = emailInput.value;
            
            if (!email) {
                alert('Please enter an email.');
                return;
            }

            try {
                const response = await fetch('https://x51lo0cnd3.execute-api.us-east-2.amazonaws.com/Stage1/makeReservation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        restaurantAddress: restaurantAddress,
                        tableNum: tableNum, 
                        reserveTime: reserveTime,
                    }),
                });

                const responseData = await response.json();
                console.log('Response Data:', responseData);
                //console.log('Response Status:', response.status);
                
                if (responseData.statusCode === 201) {
                    alert('Reservation successful!');
                    fetchReservations(); // Refresh reservations
                } else {
                    //const data = await response.json();
                    alert(responseData.error || 'Failed to make reservation.');
                }
            } catch (error) {
                console.error('Error making reservation:', error.message);
                alert('An unexpected error occurred.');
            }
        }
        function adminLogin() {
            window.location.href = 'http://teamjojobucket.s3-website.us-east-2.amazonaws.com/adminLogin.html';
        }

        function restaurantLogin() {
            window.location.href = 'http://teamjojobucket.s3-website.us-east-2.amazonaws.com/ownerLogin.html';
        }

        // Fetch and display reservations on page load
        //document.addEventListener('DOMContentLoaded', () => {
        fetchReservations();
        
    </script>
</body>
</html>
