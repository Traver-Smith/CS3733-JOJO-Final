<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Restaurant</title>
  <style>
    /* Existing CSS styles remain unchanged */
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #333;
      color: #fff;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-left, .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-title {
      flex-grow: 1;
      text-align: center;
    }
    .header-title .main-title {
      margin: 0;
      font-size: 20px;
      font-weight: bold;
    }
    .header-title .subtitle {
      margin: 0;
      font-size: 14px;
      color: #ccc;
    }
    button {
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 {
      font-size: 2.5rem;
      margin: 0;
    }
    .header p {
      font-size: 1.2rem;
      color: #666;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 5px;
      box-sizing: border-box;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .section h2 {
      font-size: 1.5rem;
      margin-bottom: 10px;
    }
    .section textarea, .section select, .section input {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }
    .days-of-week {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    .days-of-week label {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      gap: 5px;
    }
    .days-of-week input[type="checkbox"] {
      margin: 0;
      width: 16px;
      height: 16px;
    }
    .table-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .table-item span {
      flex: 1;
      font-weight: bold;
    }
    .table-item button {
      background-color: #dc3545;
    }
    .table-item button:hover {
      background-color: #c82333;
    }
    .publish-btn, .activate-btn {
      text-align: center;
      margin-top: 30px;
    }
    .publish-btn button, .activate-btn button {
      background-color: #28a745;
      color: white;
      font-size: 1.2rem;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    .publish-btn button:hover, .activate-btn button:hover {
      background-color: #218838;
    }
    .error {
      color: #dc3545;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
    }
    /* Disable input styles */
    .disabled {
      background-color: #e9ecef;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <button onclick="makeReservation()">Make a Reservation</button>
    </div>
    <div class="header-title">
      <h1 class="main-title">Tables4u</h1>
      <h2 class="subtitle">Edit Restaurant</h2>
    </div>
    <div class="header-right">
      <button onclick="adminLogin()">Admin Login</button>
      <button onclick="restaurantLogin()">Restaurant Login</button>
    </div>
  </header>
  <div class="container">
    <div class="header">
      <h1>Edit Restaurant</h1>
      <p id="restaurant_name_display">(Restaurant Name)</p>
    </div>

    <!-- Hours of Operation Section -->
    <div class="section">
      <h2>Hours of Operation</h2>
      <label for="opening_time">Opening Time:</label>
      <select id="opening_time">
        <option value="">Select Opening Time</option>
        <option value="06:00:00">6:00 AM</option>
        <option value="07:00:00">7:00 AM</option>
        <option value="08:00:00">8:00 AM</option>
        <option value="09:00:00">9:00 AM</option>
        <option value="10:00:00">10:00 AM</option>
        <option value="11:00:00">11:00 AM</option>
        <option value="12:00:00">12:00 PM</option>
      </select>
      <label for="closing_time">Closing Time:</label>
      <select id="closing_time">
        <option value="">Select Closing Time</option>
        <option value="18:00:00">6:00 PM</option>
        <option value="19:00:00">7:00 PM</option>
        <option value="20:00:00">8:00 PM</option>
        <option value="21:00:00">9:00 PM</option>
        <option value="22:00:00">10:00 PM</option>
        <option value="23:00:00">11:00 PM</option>
        <option value="00:00:00">12:00 AM</option>
      </select>
      <p>Select days the restaurant is open:</p>
      <div class="days-of-week">
        <label><input type="checkbox" value="Monday" checked> Monday</label>
        <label><input type="checkbox" value="Tuesday" checked> Tuesday</label>
        <label><input type="checkbox" value="Wednesday" checked> Wednesday</label>
        <label><input type="checkbox" value="Thursday" checked> Thursday</label>
        <label><input type="checkbox" value="Friday" checked> Friday</label>
        <label><input type="checkbox" value="Saturday" checked> Saturday</label>
        <label><input type="checkbox" value="Sunday" checked> Sunday</label>
      </div>
    </div>

    <!-- Tables Section -->
    <div class="section">
      <h2>Tables</h2>
      <div class="add-table-form">
        <input type="number" id="table_seats" placeholder="Number of seats" min="1" required>
        <button onclick="addTable()">Add Table</button>
      </div>
      <div class="table-list" id="table_list"></div>
      <div class="error" id="error_message"></div>
    </div>
    <div class="publish-btn">
      <button onclick="saveRestaurant()">Save</button>
    </div>
    <div class="activate-btn">
      <button onclick="activateRestaurant()">Activate Restaurant</button>
    </div>
  </div>

  <script>
    // Retrieve restaurant address from sessionStorage
    const restaurantAddress = sessionStorage.getItem('restaurantUsername');
    document.getElementById('restaurant_name_display').textContent = `Editing: ${restaurantAddress}`;
    let restaurantName = ''; // Will be set after fetching restaurant details
    let isActive = false;
    let tables = [];

    // Fetch existing tables to determine the next table number
    async function fetchExistingTables() {
      try {
        const response = await fetch('https://jx7q3te4na.execute-api.us-east-2.amazonaws.com/Stage2/listTables', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ address: restaurantAddress }),
        });

        const data = await response.json();

        console.log('listTables API response:', data); // Debugging

        if (response.status === 200) {
          const parsedData = JSON.parse(data.body);

          if (Array.isArray(parsedData.data)) {
            tables = parsedData.data;
            renderTables();
          } else {
            console.warn('No existing tables found or error fetching tables.');
            tables = [];
            renderTables();
          }
        } else {
          console.warn('Error fetching tables:', data.error);
          tables = [];
          renderTables();
        }
      } catch (error) {
        console.error('Error fetching existing tables:', error);
      }
    }

    function makeReservation() {
      window.location.href = '/make-reservation';
    }

    function adminLogin() {
      window.location.href = '/admin/login';
    }

    function restaurantLogin() {
      window.location.href = '/restaurant/login';
    }

    function renderTables() {
      const tableList = document.getElementById('table_list');
      if (tables.length === 0) {
        tableList.innerHTML = '<p>No tables added yet.</p>';
        return;
      }
      tableList.innerHTML = tables
        .map(
          (table) =>
            `<div class="table-item" id="table_${table.tableID}">
              <span>Table ${table.tableID}</span>
              <span>Seats: ${table.numSeats}</span>
              <button onclick="removeTable(${table.tableID})">Remove</button>
            </div>`
        )
        .join('');
    }

    async function addTable() {
      const numSeats = parseInt(document.getElementById('table_seats').value, 10);
      const errorDiv = document.getElementById('error_message');
      errorDiv.textContent = '';

      if (isActive) {
        errorDiv.textContent = 'Cannot add tables after activation.';
        return;
      }

      if (!numSeats || !restaurantAddress) {
        errorDiv.textContent = 'Please enter the number of seats and ensure you are logged in.';
        return;
      }

      try {
        const response = await fetch('https://jx7q3te4na.execute-api.us-east-2.amazonaws.com/Stage2/addTable', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            numSeats: numSeats,
            restaurantID: restaurantAddress,
          }),
        });

        const data = await response.json();

        if (response.status === 200) {
          alert('Table added successfully!');
          // Fetch the updated list of tables
          fetchExistingTables();
          document.getElementById('table_seats').value = '';
        } else {
          errorDiv.textContent = data.error || 'An error occurred while adding the table.';
        }
      } catch (error) {
        console.error('Error adding table:', error);
        errorDiv.textContent = 'An unexpected error occurred. Please try again later.';
      }
    }

    async function removeTable(tableID) {
      const errorDiv = document.getElementById('error_message');
      errorDiv.textContent = '';

      if (!restaurantAddress || !tableID) {
        errorDiv.textContent = 'Invalid request. Restaurant address or Table ID missing.';
        return;
      }

      const confirmDelete = confirm(`Are you sure you want to remove Table ${tableID}?`);
      if (!confirmDelete) {
        return;
      }

      try {
        const response = await fetch('https://jx7q3te4na.execute-api.us-east-2.amazonaws.com/Stage2/removeTable', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            tableID: tableID,
            restaurantID: restaurantAddress,
          }),
        });

        const data = await response.json();

        if (response.status === 200) {
          alert(`Table ${tableID} removed successfully!`);
          // Remove the table from the local array and re-render
          tables = tables.filter((table) => table.tableID !== tableID);
          renderTables();
        } else {
          errorDiv.textContent = data.error || `Failed to remove Table ${tableID}.`;
        }
      } catch (error) {
        console.error('Error removing table:', error);
        errorDiv.textContent = 'An unexpected error occurred. Please try again later.';
      }
    }

    async function saveRestaurant() {
      const openTime = document.getElementById('opening_time').value;
      const closeTime = document.getElementById('closing_time').value;
      const daysOfWeek = document.querySelectorAll('.days-of-week input[type="checkbox"]');
      const openDays = [];
      const errorDiv = document.getElementById('error_message');
      errorDiv.textContent = '';

      // Retrieve restaurant details from sessionStorage
      const storedRestaurantName = sessionStorage.getItem('restaurantName');

      // Use the stored restaurant name
      restaurantName = storedRestaurantName;

      // Collect selected days
      daysOfWeek.forEach((day) => {
        if (day.checked) {
          openDays.push(day.value);
        }
      });

      if (!openTime || !closeTime) {
        errorDiv.textContent = 'Please select both opening and closing times.';
        return;
      }

      if (openDays.length === 0) {
        errorDiv.textContent = 'Please select at least one day the restaurant is open.';
        return;
      }

      // Determine closed days by excluding selected days
      const allDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      const closedDays = allDays.filter((day) => !openDays.includes(day)).join(',');

      try {
        // Call the API to save restaurant details
        const response = await fetch('https://jx7q3te4na.execute-api.us-east-2.amazonaws.com/Stage2/editRestaurant', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            restaurantName: storedRestaurantName, // From sessionStorage
            address: restaurantAddress, // Include the address in the request body
            openTime: openTime,
            closeTime: closeTime,
            closedDays: closedDays,
          }),
        });

        const data = await response.json();

        if (response.status === 200) {
          alert('Restaurant details saved successfully!');
          // Optionally re-render the restaurant to confirm changes
          renderRestaurant();
        } else {
          errorDiv.textContent = data.error || 'An error occurred while saving restaurant details.';
        }
      } catch (error) {
        console.error('Error saving restaurant details:', error);
        errorDiv.textContent = 'An unexpected error occurred. Please try again later.';
      }
    }

    async function renderRestaurant() {
  const errorDiv = document.getElementById('error_message');
  errorDiv.textContent = '';

  if (!restaurantAddress) {
    errorDiv.textContent = 'Restaurant address is missing. Please log in again.';
    return;
  }

  try {
    const response = await fetch('https://jx7q3te4na.execute-api.us-east-2.amazonaws.com/Stage2/getRestaurant', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ address: restaurantAddress }),
    });

    const data = await response.json();

    console.log('getRestaurant API response:', data); // Debugging

    if (response.status === 200) {
      const restaurantData = JSON.parse(data.body).restaurant;

      if (!restaurantData) {
        errorDiv.textContent = 'Error: No restaurant data returned from the API.';
        return;
      }

      const { restaurantName: name, openTime, closeTime, closedDays, isActive: activeStatus } = restaurantData;

      // Set the restaurant name in the display
      restaurantName = name;
      if (!restaurantName) {
        errorDiv.textContent = 'Error: Restaurant name is missing in the API response.';
        return;
      }

      document.getElementById('restaurant_name_display').textContent = `Editing: ${restaurantName}`;
      sessionStorage.setItem('restaurantName', restaurantName); // Save name for future use

      // Render open and close hours
      document.getElementById('opening_time').value = openTime || '';
      document.getElementById('closing_time').value = closeTime || '';

      // Render open days
      const closedDaysArray = closedDays ? closedDays.split(',') : [];
      const daysOfWeek = document.querySelectorAll('.days-of-week input[type="checkbox"]');

      daysOfWeek.forEach((day) => {
        day.checked = !closedDaysArray.includes(day.value);
      });

      // Check if the restaurant is active and disable editing if necessary
      if (activeStatus) {
        isActive = true;
        disableEditing();
      }

      console.log('Restaurant details rendered successfully.');
    } else {
      errorDiv.textContent = data.error || 'Error retrieving restaurant details.';
    }
  } catch (error) {
    console.error('Error fetching restaurant details:', error);
    errorDiv.textContent = 'An unexpected error occurred. Please try again later.';
  }
}


    async function activateRestaurant() {
      // Your existing activateRestaurant function remains unchanged
    }

    function disableEditing() {
      // Your existing disableEditing function remains unchanged
    }

    // Call functions on page load
    renderRestaurant(); // Populate restaurant details
    fetchExistingTables(); // Fetch tables
  </script>
</body>
</html>